"use strict";var xe=Object.create;var S=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var ve=Object.getOwnPropertyNames;var Ne=Object.getPrototypeOf,be=Object.prototype.hasOwnProperty;var ke=(t,e,o,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ve(e))!be.call(t,s)&&s!==o&&S(t,s,{get:()=>e[s],enumerable:!(r=Ue(e,s))||r.enumerable});return t};var I=(t,e,o)=>(o=t!=null?xe(Ne(t)):{},ke(e||!t||!t.__esModule?S(o,"default",{value:t,enumerable:!0}):o,t));var ut=require("dotenv/config"),k=I(require("express"));var O=require("jwt-decode");var D=require("drizzle-orm/node-postgres"),A=require("pg"),ze=new A.Pool({connectionString:process.env.DATABASE_URL}),d=(0,D.drizzle)(ze);var a=require("drizzle-orm");var T=require("drizzle-orm"),l=require("drizzle-orm/pg-core");var q=require("drizzle-orm/pg-core"),f=(0,q.pgTable)("users",{id:(0,q.uuid)("id").primaryKey().defaultRandom(),name:(0,q.varchar)("name",{length:255}).notNull(),email:(0,q.varchar)("email",{length:255}).notNull().unique(),password:(0,q.varchar)("password",{length:255}).notNull()});var p=(0,l.pgTable)("estoques",{id:(0,l.uuid)("id").primaryKey().defaultRandom(),name:(0,l.varchar)("name",{length:255}).notNull(),codigo:(0,l.varchar)("codigo",{length:50}).notNull().unique().default(T.sql`floor(random()*9000 + 1000)::int`)}),n=(0,l.pgTable)("estoque_users",{id:(0,l.uuid)("id").primaryKey().defaultRandom(),estoqueId:(0,l.uuid)("estoque_id").notNull(),userId:(0,l.uuid)("user_id").notNull()},t=>({fkEstoque:(0,l.foreignKey)({columns:[t.estoqueId],foreignColumns:[p.id],name:"fk_estoque_users_estoque"}),fkUser:(0,l.foreignKey)({columns:[t.userId],foreignColumns:[f.id],name:"fk_estoque_users_user"})}));var m=require("drizzle-orm/pg-core");var i=(0,m.pgTable)("produtos",{id:(0,m.uuid)("id").primaryKey().defaultRandom(),name:(0,m.varchar)("name",{length:255}).notNull(),image:(0,m.varchar)("image",{length:255}),barcode:(0,m.varchar)("barcode",{length:50}).unique(),price:(0,m.integer)("price").notNull(),quantity:(0,m.integer)("quantity").notNull().default(0),minStock:(0,m.integer)("min_stock").notNull().default(0),estoqueId:(0,m.uuid)("estoque_id").notNull()},t=>({fkEstoque:(0,m.foreignKey)({columns:[t.estoqueId],foreignColumns:[p.id],name:"fk_produtos_estoque"})}));var _=async(t,e,o,r,s,u,y)=>{let[P]=await d.insert(i).values({name:t,image:e,barcode:o,price:r,quantity:s,minStock:u,estoqueId:y}).returning();if(!P)throw new Error("Failed to create product");return{product:P}},J=async t=>({products:(await d.select().from(i).innerJoin(n,(0,a.eq)(i.estoqueId,n.estoqueId)).where((0,a.eq)(n.userId,t))).map(o=>o.produtos)}),B=async(t,e)=>({products:(await d.select().from(i).innerJoin(n,(0,a.eq)(i.estoqueId,n.estoqueId)).where((0,a.and)((0,a.eq)(i.estoqueId,t),(0,a.eq)(n.userId,e)))).map(r=>r.produtos)}),Q=async(t,e)=>{let[o]=await d.select().from(i).innerJoin(n,(0,a.eq)(i.estoqueId,n.estoqueId)).where((0,a.and)((0,a.eq)(i.id,t),(0,a.eq)(n.userId,e)));if(!o)throw new Error("Product not found or user not authorized");return{product:o.produtos}},C=async(t,e,o)=>{if((await d.select().from(i).innerJoin(n,(0,a.eq)(i.estoqueId,n.estoqueId)).where((0,a.and)((0,a.eq)(i.id,t),(0,a.eq)(n.userId,o))).limit(1)).length===0)throw new Error("Product not found or user not authorized");return{product:(await d.update(i).set(e).where((0,a.eq)(i.id,t)).returning())[0]}},K=async(t,e)=>{if((await d.select().from(i).innerJoin(n,(0,a.eq)(i.estoqueId,n.estoqueId)).where((0,a.and)((0,a.eq)(i.id,t),(0,a.eq)(n.userId,e))).limit(1)).length===0)throw new Error("Product not found or user not authorized");return await d.delete(i).where((0,a.eq)(i.id,t)),{message:"Product deleted successfully"}},F=async(t,e,o)=>{let r=await d.select().from(i).innerJoin(n,(0,a.eq)(i.estoqueId,n.estoqueId)).where((0,a.and)((0,a.eq)(i.id,t),(0,a.eq)(n.userId,o))).limit(1);if(r.length===0)throw new Error("Product not found or user not authorized");let s=r[0].produtos.quantity;return{product:(await d.update(i).set({quantity:s+Number(e)}).where((0,a.eq)(i.id,t)).returning())[0]}},W=async(t,e,o)=>{let r=await d.select().from(i).innerJoin(n,(0,a.eq)(i.estoqueId,n.estoqueId)).where((0,a.and)((0,a.eq)(i.id,t),(0,a.eq)(n.userId,o))).limit(1);if(r.length===0)throw new Error("Product not found or user not authorized");let s=r[0].produtos.quantity;if(s-Number(e)<0)throw new Error("Insufficient quantity to decrement");return{product:(await d.update(i).set({quantity:s-Number(e)}).where((0,a.eq)(i.id,t)).returning())[0]}};var w=t=>(0,O.jwtDecode)(t).id,H=async(t,e)=>{let{name:o,image:r,barcode:s,price:u,quantity:y,minStock:P,estoqueId:z}=t.body;if(!o||!u||!y||!P||!z)return e.status(400).json({error:"Name, price, quantity, minStock, and estoqueId are required."});try{let{product:U}=await _(o,r,s,u,y,P,z);e.status(201).json({product:U})}catch(U){e.status(500).json({error:U})}},L=async(t,e)=>{let o=w(t.headers.authorization?.split(" ")[1]||"");if(!o)return e.status(400).json({error:"User ID is required."});try{let{products:r}=await J(o);e.status(200).json({products:r})}catch(r){e.status(500).json({error:r})}},$=async(t,e)=>{let{estoqueId:o}=t.params,r=w(t.headers.authorization?.split(" ")[1]||"");if(!o||!r)return e.status(400).json({error:"Estoque ID and User ID are required."});try{let{products:s}=await B(o,r);e.status(200).json({products:s})}catch(s){e.status(500).json({error:s})}},G=async(t,e)=>{let{productId:o}=t.params,r=w(t.headers.authorization?.split(" ")[1]||"");if(!o||!r)return e.status(400).json({error:"Product ID and User ID are required."});try{let s=await Q(o,r);e.status(200).json({product:s})}catch(s){e.status(500).json({error:s})}},M=async(t,e)=>{let{productId:o}=t.params,r=w(t.headers.authorization?.split(" ")[1]||""),s=t.body;if(!o||!r)return e.status(400).json({error:"Product ID and User ID are required."});try{let{product:u}=await C(o,s,r);e.status(200).json({product:u})}catch(u){e.status(500).json({error:u})}},V=async(t,e)=>{let{productId:o}=t.params,r=w(t.headers.authorization?.split(" ")[1]||"");if(!o||!r)return e.status(400).json({error:"Product ID and User ID are required."});try{await K(o,r),e.status(204).json({message:"Product deleted successfully."})}catch(s){e.status(500).json({error:s})}},X=async(t,e)=>{let{id:o}=t.params,r=w(t.headers.authorization?.split(" ")[1]||""),{quantity:s}=t.body;if(!o||!r||s===void 0)return e.status(400).json({error:"Product ID, User ID, and quantity are required."});try{let{product:u}=await F(o,s,r);e.status(200).json({product:u})}catch(u){console.error("Error incrementing product quantity:",u),e.status(500).json({error:u})}},Y=async(t,e)=>{let{id:o}=t.params,r=w(t.headers.authorization?.split(" ")[1]||""),{quantity:s}=t.body;if(!o||!r||s===void 0)return e.status(400).json({error:"Product ID, User ID, and quantity are required."});try{let{product:u}=await W(o,s,r);e.status(200).json({product:u})}catch(u){e.status(500).json({error:u})}};var me=I(require("express"));var ne=require("jwt-decode");var c=require("drizzle-orm");var Z=async(t,e)=>{let[o]=await d.insert(p).values({name:t}).returning();return await d.insert(n).values({estoqueId:o.id,userId:e}),{estoque:o}},ee=async(t,e)=>{let[o]=await d.select().from(p).where((0,c.eq)(p.codigo,t));if(!o)throw new Error("Estoque not found");let[r]=await d.select().from(n).where((0,c.and)((0,c.eq)(n.estoqueId,o.id),(0,c.eq)(n.userId,e)));if(r)throw new Error("User already joined this estoque");return await d.insert(n).values({estoqueId:o.id,userId:e}),{estoque:o}},te=async t=>({estoques:(await d.select().from(p).innerJoin(n,(0,c.eq)(p.id,n.estoqueId)).where((0,c.eq)(n.userId,t)).orderBy(p.name)).map(o=>o.estoques)}),oe=async(t,e)=>{let[o]=await d.select().from(p).innerJoin(n,(0,c.eq)(p.id,n.estoqueId)).where((0,c.and)((0,c.eq)(p.id,t),(0,c.eq)(n.userId,e)));if(!o)throw new Error("Estoque not found or user not authorized");return o.estoques},re=async(t,e,o)=>{let[r]=await d.select().from(p).innerJoin(n,(0,c.eq)(p.id,t)).where((0,c.and)((0,c.eq)(p.id,t),(0,c.eq)(n.userId,o)));if(!r)throw new Error("Estoque not found or user not authorized");return await d.update(p).set({name:e}).where((0,c.eq)(p.id,r.estoques.id)),r},se=async(t,e)=>{let[o]=await d.select().from(p).innerJoin(n,(0,c.eq)(p.id,n.estoqueId)).where((0,c.and)((0,c.eq)(p.id,t),(0,c.eq)(n.userId,e)));if(!o)throw new Error("Estoque not found or user not authorized");return await d.delete(n).where((0,c.eq)(n.estoqueId,o.estoques.id)),await d.delete(i).where((0,c.eq)(i.estoqueId,o.estoques.id)),await d.delete(p).where((0,c.eq)(p.id,o.estoques.id)),{message:"Estoque deleted successfully"}};var E=t=>(0,ne.jwtDecode)(t).id,ue=async(t,e)=>{let o=E(t.headers.authorization?.split(" ")[1]||""),{name:r}=t.body;if(!o)return e.status(401).json({error:"Unauthorized. No user ID found in token."});if(!r)return e.status(400).json({error:"Name is required."});try{let{estoque:s}=await Z(r,o);e.status(201).json({id:s.id,name:s.name,codigo:s.codigo})}catch(s){e.status(500).json({error:s})}},ie=async(t,e)=>{let o=E(t.headers.authorization?.split(" ")[1]||""),{codigo:r}=t.body;if(!o)return e.status(401).json({error:"Unauthorized. No user ID found in token."});if(!r)return e.status(400).json({error:"Codigo is required."});try{let{estoque:s}=await ee(r,o);e.status(200).json({message:"Acesso concedido ao estoque",estoque:{id:s.id,name:s.name,codigo:s.codigo}})}catch(s){e.status(500).json({error:s})}},ae=async(t,e)=>{let o=E(t.headers.authorization?.split(" ")[1]||"");if(!o)return e.status(401).json({error:"Unauthorized. No user ID found in token."});try{let{estoques:r}=await te(o);e.status(200).json({estoques:r})}catch(r){e.status(500).json({error:r})}},de=async(t,e)=>{let o=E(t.headers.authorization?.split(" ")[1]||""),{estoqueId:r}=t.params;if(!r)return e.status(400).json({error:"Estoque ID is required."});try{let s=await oe(r,o);e.status(200).json({estoque:{id:s.id,name:s.name,codigo:s.codigo}})}catch(s){e.status(404).json({error:s})}},ce=async(t,e)=>{let o=E(t.headers.authorization?.split(" ")[1]||""),{estoqueId:r}=t.params,{name:s}=t.body;if(!o)return e.status(401).json({error:"Unauthorized. No user ID found in token."});if(!r)return e.status(400).json({error:"Estoque ID is required."});if(!s)return e.status(400).json({error:"Name is required."});try{let{estoques:u}=await re(r,s,o);e.status(200).json({message:"Estoque name updated successfully.",estoque:{id:u.id,name:s}})}catch(u){e.status(500).json({error:u})}},pe=async(t,e)=>{let o=E(t.headers.authorization?.split(" ")[1]||""),{estoqueId:r}=t.params;if(!o)return e.status(401).json({error:"Unauthorized. No user ID found in token."});if(!r)return e.status(400).json({error:"Estoque ID is required."});try{let s=await se(r,o);e.status(200).json({response:s})}catch(s){e.status(500).json({error:s})}};var g=me.default.Router();g.post("/",ue);g.get("/",ae);g.get("/:estoqueId/products",$);g.get("/:estoqueId",de);g.put("/:estoqueId",ce);g.delete("/:estoqueId",pe);g.post("/join",ie);var le=g;var qe=I(require("express")),h=qe.default.Router();h.post("/",H);h.get("/",L);h.get("/:productId/details",G);h.put("/:productId",M);h.delete("/:productId",V);h.patch("/:id/increment",X);h.patch("/:id/decrement",Y);var fe=h;var je=I(require("express"));var v=I(require("bcrypt"));var N=require("drizzle-orm"),R=I(require("jsonwebtoken"));var b=process.env.JWT_SECRET||"default",ge=async(t,e,o)=>{let r=await v.default.hash(o,10),[s]=await d.insert(f).values({name:t,email:e,password:r}).returning(),u=R.default.sign({id:s.id,name:s.name},b,{expiresIn:"1h"});return{user:s,token:u}},he=async(t,e)=>{let[o]=await d.select().from(f).where((0,N.eq)(f.email,t));if(!o)throw new Error("User not found");if(!await v.default.compare(e,o.password))throw new Error("Invalid password");let s=R.default.sign({id:o.id,name:o.name},b,{expiresIn:"1h"});return{user:o,token:s}},we=async t=>{if(!t)throw new Error("No token provided");try{let e=R.default.verify(t,b),[o]=await d.select().from(f).where((0,N.eq)(f.id,e.id));if(!o)throw new Error("User not found");return o}catch{throw new Error("Invalid token")}};var ye=async(t,e)=>{let{name:o,email:r,password:s}=t.body;if(!o||!r||!s)return e.status(400).json({error:"Name, email, and password are required."});try{let{user:u,token:y}=await ge(o,r,s);e.status(201).json({user:{id:u.id,name:u.name,email:u.email},token:y})}catch(u){e.status(500).json({error:u})}},Ie=async(t,e)=>{let{email:o,password:r}=t.body;if(!o||!r)return e.status(400).json({error:"Email and password are required."});try{let{user:s,token:u}=await he(o,r);e.status(200).json({user:{id:s.id,name:s.name,email:s.email},token:u})}catch(s){e.status(401).json({error:s})}},Ee=async(t,e)=>{let o=t.headers.authorization?.split(" ")[1];if(!o)return e.status(401).json({error:"No token provided."});try{let r=await we(o);e.status(200).json({id:r.id,name:r.name,email:r.email})}catch(r){e.status(401).json({error:r})}};var x=je.default.Router();x.post("/register",ye);x.post("/login",Ie);x.get("/profile",Ee);var Pe=x;var j=(0,k.default)();j.use(k.default.json());j.use("/products",fe);j.use("/users",Pe);j.use("/estoques",le);j.get("/",(t,e)=>{e.send("Hello World!")});var Re=process.env.PORT||3e3;j.listen(Re,()=>{console.log(`Server is running on port ${Re}`)});
