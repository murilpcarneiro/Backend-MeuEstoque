"use strict";var xe=Object.create;var S=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var ve=Object.getOwnPropertyNames;var Ne=Object.getPrototypeOf,be=Object.prototype.hasOwnProperty;var ke=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ve(e))!be.call(t,s)&&s!==r&&S(t,s,{get:()=>e[s],enumerable:!(o=Ue(e,s))||o.enumerable});return t};var I=(t,e,r)=>(r=t!=null?xe(Ne(t)):{},ke(e||!t||!t.__esModule?S(r,"default",{value:t,enumerable:!0}):r,t));var nt=require("dotenv/config"),b=I(require("express"));var G=I(require("express"));var M=require("jwt-decode");var A=require("drizzle-orm/node-postgres"),D=require("pg"),ze=new D.Pool({connectionString:process.env.DATABASE_URL}),a=(0,A.drizzle)(ze);var c=require("drizzle-orm");var T=require("drizzle-orm"),l=require("drizzle-orm/pg-core");var g=require("drizzle-orm/pg-core"),f=(0,g.pgTable)("users",{id:(0,g.uuid)("id").primaryKey().defaultRandom(),name:(0,g.varchar)("name",{length:255}).notNull(),email:(0,g.varchar)("email",{length:255}).notNull().unique(),password:(0,g.varchar)("password",{length:255}).notNull()});var p=(0,l.pgTable)("estoques",{id:(0,l.uuid)("id").primaryKey().defaultRandom(),name:(0,l.varchar)("name",{length:255}).notNull(),codigo:(0,l.varchar)("codigo",{length:50}).notNull().unique().default(T.sql`floor(random()*9000 + 1000)::int`)}),n=(0,l.pgTable)("estoque_users",{id:(0,l.uuid)("id").primaryKey().defaultRandom(),estoqueId:(0,l.uuid)("estoque_id").notNull(),userId:(0,l.uuid)("user_id").notNull()},t=>({fkEstoque:(0,l.foreignKey)({columns:[t.estoqueId],foreignColumns:[p.id],name:"fk_estoque_users_estoque"}),fkUser:(0,l.foreignKey)({columns:[t.userId],foreignColumns:[f.id],name:"fk_estoque_users_user"})}));var m=require("drizzle-orm/pg-core");var u=(0,m.pgTable)("produtos",{id:(0,m.uuid)("id").primaryKey().defaultRandom(),name:(0,m.varchar)("name",{length:255}).notNull(),image:(0,m.varchar)("image",{length:255}),barcode:(0,m.varchar)("barcode",{length:50}).unique(),price:(0,m.integer)("price").notNull(),quantity:(0,m.integer)("quantity").notNull().default(0),minStock:(0,m.integer)("min_stock").notNull().default(0),estoqueId:(0,m.uuid)("estoque_id").notNull()},t=>({fkEstoque:(0,m.foreignKey)({columns:[t.estoqueId],foreignColumns:[p.id],name:"fk_produtos_estoque"})}));var _=async(t,e)=>{let[r]=await a.insert(p).values({name:t}).returning();return await a.insert(n).values({estoqueId:r.id,userId:e}),{estoque:r}},J=async(t,e)=>{let[r]=await a.select().from(p).where((0,c.eq)(p.codigo,t));if(!r)throw new Error("Estoque not found");let[o]=await a.select().from(n).where((0,c.and)((0,c.eq)(n.estoqueId,r.id),(0,c.eq)(n.userId,e)));if(o)throw new Error("User already joined this estoque");return await a.insert(n).values({estoqueId:r.id,userId:e}),{estoque:r}},B=async t=>({estoques:(await a.select().from(p).innerJoin(n,(0,c.eq)(p.id,n.estoqueId)).where((0,c.eq)(n.userId,t)).orderBy(p.name)).map(r=>r.estoques)}),Q=async(t,e)=>{let[r]=await a.select().from(p).innerJoin(n,(0,c.eq)(p.id,n.estoqueId)).where((0,c.and)((0,c.eq)(p.id,t),(0,c.eq)(n.userId,e)));if(!r)throw new Error("Estoque not found or user not authorized");return r.estoques},C=async(t,e,r)=>{let[o]=await a.select().from(p).innerJoin(n,(0,c.eq)(p.id,t)).where((0,c.and)((0,c.eq)(p.id,t),(0,c.eq)(n.userId,r)));if(!o)throw new Error("Estoque not found or user not authorized");return await a.update(p).set({name:e}).where((0,c.eq)(p.id,o.estoques.id)),o},K=async(t,e)=>{let[r]=await a.select().from(p).innerJoin(n,(0,c.eq)(p.id,n.estoqueId)).where((0,c.and)((0,c.eq)(p.id,t),(0,c.eq)(n.userId,e)));if(!r)throw new Error("Estoque not found or user not authorized");return await a.delete(n).where((0,c.eq)(n.estoqueId,r.estoques.id)),await a.delete(u).where((0,c.eq)(u.estoqueId,r.estoques.id)),await a.delete(p).where((0,c.eq)(p.id,r.estoques.id)),{message:"Estoque deleted successfully"}};var E=t=>(0,M.jwtDecode)(t).id,F=async(t,e)=>{let r=E(t.headers.authorization?.split(" ")[1]||""),{name:o}=t.body;if(!r)return e.status(401).json({error:"Unauthorized. No user ID found in token."});if(!o)return e.status(400).json({error:"Name is required."});try{let{estoque:s}=await _(o,r);e.status(201).json({id:s.id,name:s.name,codigo:s.codigo})}catch(s){e.status(500).json({error:"An error occurred while creating the stock.",errorMessage:s})}},W=async(t,e)=>{let r=E(t.headers.authorization?.split(" ")[1]||""),{codigo:o}=t.body;if(!r)return e.status(401).json({error:"Unauthorized. No user ID found in token."});if(!o)return e.status(400).json({error:"Codigo is required."});try{let{estoque:s}=await J(o,r);e.status(200).json({message:"Acesso concedido ao estoque",estoque:{id:s.id,name:s.name,codigo:s.codigo}})}catch(s){e.status(500).json({error:s.message})}},O=async(t,e)=>{let r=E(t.headers.authorization?.split(" ")[1]||"");if(!r)return e.status(401).json({error:"Unauthorized. No user ID found in token."});try{let{estoques:o}=await B(r);e.status(200).json({estoques:o})}catch(o){e.status(500).json({error:"An error occurred while fetching user stocks.",errorMessage:o})}},H=async(t,e)=>{let r=E(t.headers.authorization?.split(" ")[1]||""),{estoqueId:o}=t.params;if(!o)return e.status(400).json({error:"Estoque ID is required."});try{let s=await Q(o,r);e.status(200).json({estoque:{id:s.id,name:s.name,codigo:s.codigo}})}catch{e.status(404).json({error:"Estoque not found."})}},L=async(t,e)=>{let r=E(t.headers.authorization?.split(" ")[1]||""),{estoqueId:o}=t.params,{name:s}=t.body;if(!r)return e.status(401).json({error:"Unauthorized. No user ID found in token."});if(!o)return e.status(400).json({error:"Estoque ID is required."});if(!s)return e.status(400).json({error:"Name is required."});try{let{estoques:d}=await C(o,s,r);e.status(200).json({message:"Estoque name updated successfully.",estoque:{id:d.id,name:s}})}catch(d){e.status(500).json({error:"An error occurred while changing the stock name.",errorMessage:d})}},$=async(t,e)=>{let r=E(t.headers.authorization?.split(" ")[1]||""),{estoqueId:o}=t.params;if(!r)return e.status(401).json({error:"Unauthorized. No user ID found in token."});if(!o)return e.status(400).json({error:"Estoque ID is required."});try{let s=await K(o,r);e.status(200).json({response:s})}catch(s){e.status(500).json({error:"An error occurred while deleting the stock and its products.",errorMessage:s})}};var h=G.default.Router();h.post("/",F);h.get("/",O);h.get("/:estoqueId",H);h.put("/:estoqueId",L);h.delete("/:estoqueId",$);h.post("/join",W);var V=h;var ne=require("jwt-decode");var i=require("drizzle-orm");var X=async(t,e,r,o,s,d,y)=>{let[P]=await a.insert(u).values({name:t,image:e,barcode:r,price:o,quantity:s,minStock:d,estoqueId:y}).returning();if(!P)throw new Error("Failed to create product");return{product:P}},Y=async t=>{let e=await a.select().from(u).innerJoin(n,(0,i.eq)(u.estoqueId,n.estoqueId)).where((0,i.eq)(n.userId,t));if(e.length===0)throw new Error("No products found");return{products:e.map(r=>r.produtos)}},Z=async(t,e)=>{let r=await a.select().from(u).innerJoin(n,(0,i.eq)(u.estoqueId,n.estoqueId)).where((0,i.and)((0,i.eq)(u.estoqueId,t),(0,i.eq)(n.userId,e)));if(r.length===0)throw new Error("No products found for this estoque");return{products:r.map(o=>o.produtos)}},ee=async(t,e)=>{let[r]=await a.select().from(u).innerJoin(n,(0,i.eq)(u.estoqueId,n.estoqueId)).where((0,i.and)((0,i.eq)(u.id,t),(0,i.eq)(n.userId,e)));if(!r)throw new Error("Product not found or user not authorized");return{product:r.produtos}},te=async(t,e,r)=>{if((await a.select().from(u).innerJoin(n,(0,i.eq)(u.estoqueId,n.estoqueId)).where((0,i.and)((0,i.eq)(u.id,t),(0,i.eq)(n.userId,r))).limit(1)).length===0)throw new Error("Product not found or user not authorized");return{product:(await a.update(u).set(e).where((0,i.eq)(u.id,t)).returning())[0]}},re=async(t,e)=>{if((await a.select().from(u).innerJoin(n,(0,i.eq)(u.estoqueId,n.estoqueId)).where((0,i.and)((0,i.eq)(u.id,t),(0,i.eq)(n.userId,e))).limit(1)).length===0)throw new Error("Product not found or user not authorized");return await a.delete(u).where((0,i.eq)(u.id,t)),{message:"Product deleted successfully"}},oe=async(t,e,r)=>{let o=await a.select().from(u).innerJoin(n,(0,i.eq)(u.estoqueId,n.estoqueId)).where((0,i.and)((0,i.eq)(u.id,t),(0,i.eq)(n.userId,r))).limit(1);if(o.length===0)throw new Error("Product not found or user not authorized");let s=o[0].produtos.quantity;return{product:(await a.update(u).set({quantity:s+Number(e)}).where((0,i.eq)(u.id,t)).returning())[0]}},se=async(t,e,r)=>{let o=await a.select().from(u).innerJoin(n,(0,i.eq)(u.estoqueId,n.estoqueId)).where((0,i.and)((0,i.eq)(u.id,t),(0,i.eq)(n.userId,r))).limit(1);if(o.length===0)throw new Error("Product not found or user not authorized");let s=o[0].produtos.quantity;return{product:(await a.update(u).set({quantity:s-Number(e)}).where((0,i.eq)(u.id,t)).returning())[0]}};var w=t=>(0,ne.jwtDecode)(t).id,ue=async(t,e)=>{let{name:r,image:o,barcode:s,price:d,quantity:y,minStock:P,estoqueId:k}=t.body;if(!r||!d||!y||!P||!k)return e.status(400).json({error:"Name, price, quantity, minStock, and estoqueId are required."});try{let{product:z}=await X(r,o,s,d,y,P,k);e.status(201).json({product:z})}catch{e.status(500).json({error:"An error occurred while creating the product."})}},ie=async(t,e)=>{let r=w(t.headers.authorization?.split(" ")[1]||"");if(!r)return e.status(400).json({error:"User ID is required."});try{let{products:o}=await Y(r);e.status(200).json({products:o})}catch(o){e.status(500).json({error:o})}},ae=async(t,e)=>{let{estoqueId:r}=t.params,o=w(t.headers.authorization?.split(" ")[1]||"");if(!r||!o)return e.status(400).json({error:"Estoque ID and User ID are required."});try{let{products:s}=await Z(r,o);e.status(200).json({products:s})}catch{e.status(500).json({error:"An error occurred while fetching products."})}},de=async(t,e)=>{let{productId:r}=t.params,o=w(t.headers.authorization?.split(" ")[1]||"");if(!r||!o)return e.status(400).json({error:"Product ID and User ID are required."});try{let s=await ee(r,o);e.status(200).json({product:s})}catch{e.status(500).json({error:"An error occurred while fetching product information."})}},ce=async(t,e)=>{let{productId:r}=t.params,o=w(t.headers.authorization?.split(" ")[1]||""),s=t.body;if(!r||!o)return e.status(400).json({error:"Product ID and User ID are required."});try{let{product:d}=await te(r,s,o);e.status(200).json({product:d})}catch{e.status(500).json({error:"An error occurred while updating product information."})}},pe=async(t,e)=>{let{productId:r}=t.params,o=w(t.headers.authorization?.split(" ")[1]||"");if(!r||!o)return e.status(400).json({error:"Product ID and User ID are required."});try{await re(r,o),e.status(204).json({message:"Product deleted successfully."})}catch{e.status(500).json({error:"An error occurred while deleting the product."})}},me=async(t,e)=>{let{id:r}=t.params,o=w(t.headers.authorization?.split(" ")[1]||""),{quantity:s}=t.body;if(!r||!o||s===void 0)return e.status(400).json({error:"Product ID, User ID, and quantity are required."});try{let{product:d}=await oe(r,s,o);e.status(200).json({product:d})}catch(d){console.error("Error incrementing product quantity:",d),e.status(500).json({error:"An error occurred while incrementing product quantity."})}},le=async(t,e)=>{let{id:r}=t.params,o=w(t.headers.authorization?.split(" ")[1]||""),{quantity:s}=t.body;if(!r||!o||s===void 0)return e.status(400).json({error:"Product ID, User ID, and quantity are required."});try{let{product:d}=await se(r,s,o);e.status(200).json({product:d})}catch{e.status(500).json({error:"An error occurred while decrementing product quantity."})}};var qe=I(require("express")),q=qe.default.Router();q.post("/",ue);q.get("/",ie);q.get("/:estoqueId",ae);q.get("/:productId/details",de);q.put("/:productId",ce);q.delete("/:productId",pe);q.patch("/:id/increment",me);q.patch("/:id/decrement",le);var ge=q;var je=I(require("express"));var U=I(require("bcrypt"));var v=require("drizzle-orm"),R=I(require("jsonwebtoken"));var N=process.env.JWT_SECRET||"default",fe=async(t,e,r)=>{let o=await U.default.hash(r,10),[s]=await a.insert(f).values({name:t,email:e,password:o}).returning(),d=R.default.sign({id:s.id,name:s.name},N,{expiresIn:"1h"});return{user:s,token:d}},he=async(t,e)=>{let[r]=await a.select().from(f).where((0,v.eq)(f.email,t));if(!r)throw new Error("User not found");if(!await U.default.compare(e,r.password))throw new Error("Invalid password");let s=R.default.sign({id:r.id,name:r.name},N,{expiresIn:"1h"});return{user:r,token:s}},we=async t=>{if(!t)throw new Error("No token provided");try{let e=R.default.verify(t,N),[r]=await a.select().from(f).where((0,v.eq)(f.id,e.id));if(!r)throw new Error("User not found");return r}catch{throw new Error("Invalid token")}};var ye=async(t,e)=>{let{name:r,email:o,password:s}=t.body;if(!r||!o||!s)return e.status(400).json({error:"Name, email, and password are required."});try{let{user:d,token:y}=await fe(r,o,s);e.status(201).json({user:{id:d.id,name:d.name,email:d.email},token:y})}catch{e.status(500).json({error:"An error occurred while creating the user."})}},Ie=async(t,e)=>{let{email:r,password:o}=t.body;if(!r||!o)return e.status(400).json({error:"Email and password are required."});try{let{user:s,token:d}=await he(r,o);e.status(200).json({user:{id:s.id,name:s.name,email:s.email},token:d})}catch(s){e.status(401).json({error:s.message})}},Ee=async(t,e)=>{let r=t.headers.authorization?.split(" ")[1];if(!r)return e.status(401).json({error:"No token provided."});try{let o=await we(r);e.status(200).json({id:o.id,name:o.name,email:o.email})}catch(o){e.status(401).json({error:o.message})}};var x=je.default.Router();x.post("/register",ye);x.post("/login",Ie);x.get("/profile",Ee);var Pe=x;var j=(0,b.default)();j.use(b.default.json());j.use("/products",ge);j.use("/users",Pe);j.use("/estoques",V);j.get("/",(t,e)=>{e.send("Hello World!")});var Re=process.env.PORT||3e3;j.listen(Re,()=>{console.log(`Server is running on port ${Re}`)});
